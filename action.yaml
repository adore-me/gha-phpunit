name: 'AdoreMe Tech PHPUnit Action'
description: 'Run PHPUnit tests (and optionally coverage)'
inputs:
  php-image:
    description: 'The PHP image to use'
    required: true
  report-path:
    description: 'PHPUnit report file path'
    required: true
    default: './build/reports/phpunit-junit.xml'
  enable-mysql:
    description: 'Enable MySQL'
    required: true
    default: 'false'
  enable-redis:
    description: 'Enable Redis'
    required: true
    default: 'false'
  enable-workers:
    description: 'Enable Workers'
    required: true
    default: 'false'
  workers-conf-path:
    description: 'Workers configuration file path'
    required: true
    default: 'ci/worker-confs/supervisor_dev_test_workers.conf'
  with-coverage:
    description: 'Run coverage'
    required: true
    default: 'true'
  coverage-path:
    description: 'Coverage file path'
    required: true
    default: './build/reports/clover-coverage.xml'
runs:
  using: 'composite'
  steps:
    - name: 'Start MySql'
      id: start-mysql
      if: ${{ inputs.enable-mysql == 'true' }}
      uses: adore-me/gha-mysql@v0.0.7
    - name: 'Start Redis'
      id: start-redis
      if: ${{ inputs.enable-redis == 'true' }}
      uses: adore-me/gha-redis@v0.0.1
    - name: 'Run PHPUnit'
      run: $GITHUB_ACTION_PATH/phpunit.sh
      shell: bash
      env:
        INPUT_PHP_IMAGE: ${{ inputs.php-image }}
        MYSQL_CONTAINER_IP: ${{ steps.start-mysql.outputs.container-ip }}
        REDIS_CONTAINER_IP: ${{ steps.start-redis.outputs.container-ip }}
        INPUT_REPORT_PATH: ${{ inputs.report-path }}
        INPUT_ENABLE_MYSQL: ${{ inputs.enable-mysql }}
        INPUT_ENABLE_REDIS: ${{ inputs.enable-redis }}
        INPUT_ENABLE_WORKERS: ${{ inputs.enable-workers }}
        INPUT_WORKERS_CONF_PATH: ${{ inputs.workers-conf-path }}
        INPUT_WITH_COVERAGE: ${{ inputs.with-coverage }}
        INPUT_COVERAGE_PATH: ${{ inputs.coverage-path }}
    - name: 'Stop MySql'
      if: ${{ inputs.enable-mysql == 'true' }}
      shell: bash
      run: |
        docker stop mysql -t 0
        docker rm mysql
    - name: 'Stop Redis'
      if: ${{ inputs.enable-redis == 'true' }}
      shell: bash
      run: |
        docker stop redis -t 0
        docker rm redis
    - name: 'Publish PHPUnit Results'
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2.0.0
      with:
        check_name: 'PHPUnit'
        comment_title: 'PHPUnit Results'
        report_individual_runs: true
        junit_files: ${{ inputs.report-path }}
    - name: 'Publish Coverage'
      if: ${{ inputs.run-coverage == 'true' }}
      uses: lucassabreu/comment-coverage-clover@main
      with:
        file: ${{ inputs.coverage-path }}
        dir-prefix: '/var/www'
